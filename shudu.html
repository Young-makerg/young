<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数独游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                        danger: '#EF4444',
                        disabled: '#9CA3AF',
                        sameNumber: '#FDE68A', // 相同数字高亮色
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .cell-border {
                @apply border border-gray-300;
            }
            .cell-highlight {
                @apply bg-blue-100 transition-colors duration-200;
            }
            .cell-selected {
                @apply bg-blue-200 transition-colors duration-200;
            }
            .cell-error {
                @apply bg-red-100 transition-colors duration-200;
            }
            .btn-hover {
                @apply hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200;
            }
            .grid-line {
                @apply border-2 border-gray-800;
            }
            .sudoku-grid-container {
                @apply inline-block p-2 bg-gray-100 rounded-lg shadow-md;
            }
            .error-indicator {
                @apply w-6 h-6 rounded-full border-2 flex items-center justify-center text-sm font-medium transition-all duration-300;
            }
            .error-indicator-filled {
                @apply bg-danger text-white border-danger;
            }
            .error-indicator-empty {
                @apply bg-white text-gray-300 border-gray-300;
            }
            .number-count {
                @apply text-xs absolute bottom-0 right-0 bg-gray-200 rounded-full w-4 h-4 flex items-center justify-center;
            }
            .number-button {
                @apply relative bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md h-10 flex items-center justify-center font-bold transition-colors duration-200;
            }
            .number-button-disabled {
                @apply bg-gray-200 text-gray-400 cursor-not-allowed;
            }
            .same-number-highlight {
                @apply bg-sameNumber transition-colors duration-200;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-gray-200 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 顶部标题区域 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-dark mb-2 tracking-tight">
                <span class="text-primary">数</span><span class="text-accent">独</span>
                <span class="text-[clamp(1rem,2vw,1.5rem)] font-normal text-gray-600 ml-2">Sudoku</span>
            </h1>
            <p class="text-gray-600 max-w-2xl mx-auto">锻炼逻辑思维的经典数字游戏，将数字1-9填入空格，使每行、每列和每个3x3小九宫格内均不重复。</p>
        </header>

        <!-- 游戏区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：游戏信息 -->
            <div class="lg:col-span-1 order-2 lg:order-1">
                <div class="bg-white rounded-xl shadow-lg p-6 h-full flex flex-col">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-dark mb-3 flex items-center">
                            <i class="fa fa-trophy text-accent mr-2"></i>游戏进度
                        </h2>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-sm text-gray-500 mb-1">已用时</p>
                                <p id="timer" class="text-2xl font-bold text-primary">00:00</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-sm text-gray-500 mb-1">完成度</p>
                                <p id="progress" class="text-2xl font-bold text-secondary">0%</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <p class="text-sm text-gray-500 mb-1">难度</p>
                            <div class="flex items-center">
                                <select id="difficulty" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                                    <option value="easy">简单</option>
                                    <option value="medium" selected>中等</option>
                                    <option value="hard">困难</option>
                                    <option value="expert">专家</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm text-gray-500 mb-2">剩余错误次数</p>
                            <div class="flex space-x-2 justify-center" id="error-indicators">
                                <div class="error-indicator error-indicator-filled">1</div>
                                <div class="error-indicator error-indicator-filled">2</div>
                                <div class="error-indicator error-indicator-filled">3</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-dark mb-3 flex items-center">
                            <i class="fa fa-info-circle text-primary mr-2"></i>游戏说明
                        </h2>
                        <ul class="text-gray-600 space-y-2 text-sm">
                            <li class="flex items-start">
                                <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                <span>点击单元格后，使用数字键盘输入1-9</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                <span>错误的数字会显示为红色背景</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                <span>点击"清除"按钮删除当前选中单元格的数字</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                <span>点击已有数字可高亮显示所有相同数字</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa fa-exclamation-circle text-danger mt-1 mr-2"></i>
                                <span>最多允许3次错误，超过后游戏重新开始</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa fa-info-circle text-primary mt-1 mr-2"></i>
                                <span>数字按钮显示剩余可填次数，填完后自动禁用</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa fa-info-circle text-primary mt-1 mr-2"></i>
                                <span>行列/九宫格只剩1格时，仅允许填入唯一数字</span>
                            </li>
                        </ul>
                    </div>

                    <div class="mt-auto">
                        <div class="grid grid-cols-2 gap-3">
                            <button id="new-game" class="bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center btn-hover">
                                <i class="fa fa-refresh mr-2"></i>新游戏
                            </button>
                            <button id="hint" class="bg-accent hover:bg-accent/90 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center btn-hover">
                                <i class="fa fa-lightbulb-o mr-2"></i>提示
                            </button>
                        </div>
                        <div class="text-center text-gray-600 mt-2" id="hint-count">剩余提示: 3</div>
                        <!-- <button id="solve" class="w-full mt-3 bg-secondary hover:bg-secondary/90 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center btn-hover">
                            <i class="fa fa-magic mr-2"></i>显示答案
                        </button> -->
                    </div>
                </div>
            </div>

            <!-- 右侧：数独棋盘 -->
            <div class="lg:col-span-2 order-1 lg:order-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-dark flex items-center">
                            <i class="fa fa-th text-primary mr-2"></i>数独棋盘
                        </h2>
                        <div class="flex space-x-2">
                            <button id="clear" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium btn-hover">
                                <i class="fa fa-eraser mr-1"></i>清除
                            </button>
                            <button id="check" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-medium btn-hover">
                                <i class="fa fa-check mr-1"></i>检查
                            </button>
                        </div>
                    </div>

                    <!-- 数独棋盘 -->
                    <div class="flex justify-center mb-6">
                        <div class="sudoku-grid-container">
                            <div id="sudoku-grid" class="grid grid-cols-9 grid-rows-9 border-4 border-gray-800 rounded-md overflow-hidden">
                                <!-- 数独单元格将由JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>

                    <!-- 数字选择器 -->
                    <div id="number-pad" class="grid grid-cols-9 gap-2 max-w-md mx-auto mb-2">
                        <!-- 数字按钮将由JavaScript动态生成 -->
                    </div>

                    <!-- 游戏结果弹窗 -->
                    <div id="result-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
                        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
                            <div class="text-center">
                                <div id="result-icon" class="text-6xl mb-4"></div>
                                <h2 id="result-title" class="text-2xl font-bold mb-2"></h2>
                                <p id="result-message" class="text-gray-600 mb-6"></p>
                                <button id="play-again" class="bg-primary hover:bg-primary/90 text-white py-3 px-8 rounded-lg font-medium btn-hover">
                                    再玩一次
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 错误次数超限弹窗 -->
                    <div id="errors-exceeded-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
                        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
                            <div class="text-center">
                                <div class="fa fa-times-circle text-6xl text-danger mb-4"></div>
                                <h2 class="text-2xl font-bold mb-2 text-danger">错误次数超限</h2>
                                <p class="text-gray-600 mb-6">你已犯3次错误，游戏将重新开始。</p>
                                <button id="restart-after-errors" class="bg-primary hover:bg-primary/90 text-white py-3 px-8 rounded-lg font-medium btn-hover">
                                    重新开始
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>© 2025 数独游戏 | 锻炼逻辑思维的经典数字游戏</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 游戏状态
            let board = []; // 完整数独解
            let puzzle = []; // 当前谜题
            let solution = []; // 正确答案
            let selectedCell = null; // 当前选中单元格
            let selectedNumber = null; // 当前选中数字
            let timer = null; // 计时器
            let timeElapsed = 0; // 已用时间(秒)
            let gameStarted = false; // 游戏是否开始
            let errors = 0; // 错误次数
            const maxErrors = 3; // 最大错误次数
            let numberCounts = Array(10).fill(9); // 数字剩余次数(1-9)
            let requiredNumbers = []; // 行列/九宫格唯一解
            
            // 初始化棋盘
            function initializeBoard() {
                const grid = document.getElementById('sudoku-grid');
                grid.innerHTML = '';
                
                // 创建81个单元格
                for (let i = 0; i < 81; i++) {
                    const row = Math.floor(i / 9);
                    const col = i % 9;
                    const cell = document.createElement('div');
                    cell.id = `cell-${row}-${col}`;
                    cell.className = 'cell-border w-10 h-10 md:w-12 md:h-12 flex items-center justify-center text-lg md:text-xl font-medium';
                    
                    // 3x3网格粗线
                    if (row === 2 || row === 5) cell.className += ' border-b-2';
                    if (col === 2 || col === 5) cell.className += ' border-r-2';
                    
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    grid.appendChild(cell);
                }
                
                // 创建数字选择器
                createNumberPad();
            }

            // 处理单元格点击
            function handleCellClick(row, col) {
                clearSameNumberHighlights(); // 清除之前高亮
                
                const cell = document.getElementById(`cell-${row}-${col}`);
                const cellValue = cell.textContent;
                
                // 点击已有数字时高亮所有相同数字
                if (cellValue) {
                    highlightSameNumbers(+cellValue);
                    selectedNumber = +cellValue;
                    selectCell(row, col); // 选中该单元格
                } else {
                    // 选择空单元格
                    selectCell(row, col);
                    selectedNumber = null;
                }
            }

            // 高亮相同数字
            function highlightSameNumbers(num) {
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cell = document.getElementById(`cell-${i}-${j}`);
                        if (cell.textContent === num.toString()) {
                            cell.classList.add('same-number-highlight');
                        }
                    }
                }
            }

            // 清除相同数字高亮
            function clearSameNumberHighlights() {
                document.querySelectorAll('.same-number-highlight').forEach(cell => {
                    cell.classList.remove('same-number-highlight');
                });
            }

            // 创建数字选择器
            function createNumberPad() {
                const numberPad = document.getElementById('number-pad');
                numberPad.innerHTML = '';
                
                for (let i = 1; i <= 9; i++) {
                    const button = document.createElement('button');
                    button.className = 'number-button';
                    button.textContent = i;
                    button.dataset.number = i;
                    
                    // 添加剩余次数显示
                    const countSpan = document.createElement('span');
                    countSpan.className = 'number-count';
                    countSpan.textContent = '9';
                    button.appendChild(countSpan);
                    
                    // 点击事件
                    button.addEventListener('click', () => {
                        if (selectedCell) {
                            const row = +selectedCell.dataset.row;
                            const col = +selectedCell.dataset.col;
                            const num = +button.dataset.number;
                            
                            // 检查唯一解限制
                            if (requiredNumbers.length > 0) {
                                const required = requiredNumbers.find(r => r.row === row && r.col === col);
                                if (required && required.number !== num) {
                                    showResultModal(false, `此单元格必须填入数字 ${required.number}`);
                                    return;
                                }
                            }
                            
                            fillCell(row, col, num);
                        }
                    });
                    
                    numberPad.appendChild(button);
                }
            }

            // 更新数字剩余次数
            function updateNumberCounts() {
                numberCounts = Array(10).fill(9);
                
                // 计算已填数字
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (puzzle[i][j] !== 0) {
                            numberCounts[puzzle[i][j]]--;
                        }
                    }
                }
                
                // 更新UI
                const numberButtons = document.querySelectorAll('.number-button');
                numberButtons.forEach(button => {
                    const num = +button.dataset.number;
                    const countSpan = button.querySelector('.number-count');
                    countSpan.textContent = numberCounts[num];
                    
                    // 数字填完后禁用按钮
                    if (numberCounts[num] === 0) {
                        button.classList.add('number-button-disabled');
                    } else {
                        button.classList.remove('number-button-disabled');
                    }
                });
                
                // 检查唯一解
                checkForSingleEmptyCells();
            }

            // 检查行列/九宫格唯一解
            function checkForSingleEmptyCells() {
                requiredNumbers = [];
                
                // 检查每行
                for (let i = 0; i < 9; i++) {
                    const nums = new Set();
                    let empty = null;
                    let emptyCount = 0;
                    
                    for (let j = 0; j < 9; j++) {
                        if (puzzle[i][j] !== 0) nums.add(puzzle[i][j]);
                        else { empty = { row: i, col: j }; emptyCount++; }
                    }
                    
                    if (emptyCount === 1) {
                        for (let n = 1; n <= 9; n++) {
                            if (!nums.has(n)) {
                                requiredNumbers.push({...empty, number: n});
                                break;
                            }
                        }
                    }
                }
                
                // 检查每列
                for (let j = 0; j < 9; j++) {
                    const nums = new Set();
                    let empty = null;
                    let emptyCount = 0;
                    
                    for (let i = 0; i < 9; i++) {
                        if (puzzle[i][j] !== 0) nums.add(puzzle[i][j]);
                        else { empty = { row: i, col: j }; emptyCount++; }
                    }
                    
                    if (emptyCount === 1) {
                        for (let n = 1; n <= 9; n++) {
                            if (!nums.has(n)) {
                                requiredNumbers.push({...empty, number: n});
                                break;
                            }
                        }
                    }
                }
                
                // 检查九宫格
                for (let br = 0; br < 3; br++) {
                    for (let bc = 0; bc < 3; bc++) {
                        const nums = new Set();
                        let empty = null;
                        let emptyCount = 0;
                        const startRow = br * 3;
                        const startCol = bc * 3;
                        
                        for (let i = startRow; i < startRow + 3; i++) {
                            for (let j = startCol; j < startCol + 3; j++) {
                                if (puzzle[i][j] !== 0) nums.add(puzzle[i][j]);
                                else { empty = { row: i, col: j }; emptyCount++; }
                            }
                        }
                        
                        if (emptyCount === 1) {
                            for (let n = 1; n <= 9; n++) {
                                if (!nums.has(n)) {
                                    requiredNumbers.push({...empty, number: n});
                                    break;
                                }
                            }
                        }
                    }
                }
                
                // 更新按钮状态
                updateNumberButtonsState();
            }

            // 更新数字按钮状态
            function updateNumberButtonsState() {
                if (!selectedCell) return;
                
                const row = +selectedCell.dataset.row;
                const col = +selectedCell.dataset.col;
                const required = requiredNumbers.find(r => r.row === row && r.col === col);
                const numberButtons = document.querySelectorAll('.number-button');
                
                numberButtons.forEach(button => {
                    const num = +button.dataset.number;
                    
                    // 数字填完或非唯一解时禁用
                    if (numberCounts[num] === 0 || (required && required.number !== num)) {
                        button.classList.add('number-button-disabled');
                    } else {
                        button.classList.remove('number-button-disabled');
                    }
                });
            }

            // 选择单元格
            function selectCell(row, col) {
                if (selectedCell) selectedCell.classList.remove('cell-selected');
                
                selectedCell = document.getElementById(`cell-${row}-${col}`);
                
                // 预填数字不可选
                // if (selectedCell && selectedCell.classList.contains('text-gray-800')) {
                //     selectedCell = null;
                //     return;
                // }
                
                if (selectedCell) {
                    selectedCell.classList.add('cell-selected');
                    highlightRelatedCells(row, col);
                    updateNumberButtonsState();
                }
            }

            // 高亮相关单元格
            function highlightRelatedCells(row, col) {
                document.querySelectorAll('.cell-highlight').forEach(cell => cell.classList.remove('cell-highlight'));
                
                // 同行同列同九宫格高亮
                for (let i = 0; i < 9; i++) {
                    document.getElementById(`cell-${row}-${i}`)?.classList.add('cell-highlight');
                    document.getElementById(`cell-${i}-${col}`)?.classList.add('cell-highlight');
                }
                
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let i = startRow; i < startRow + 3; i++) {
                    for (let j = startCol; j < startCol + 3; j++) {
                        document.getElementById(`cell-${i}-${j}`)?.classList.add('cell-highlight');
                    }
                }
            }

            // 填充单元格
            function fillCell(row, col, num) {
                if (puzzle[row][col] !== 0) return;
                
                const cell = document.getElementById(`cell-${row}-${col}`);
                cell.textContent = num;
                cell.classList.add('text-primary');
                
                // 检查正确性
                if (num === solution[row][col]) {
                    cell.classList.remove('cell-error');
                    puzzle[row][col] = num;
                    updateNumberCounts();
                } else {
                    cell.classList.add('cell-error');
                    incrementErrors();
                }
                
                checkGameCompletion();
            }

            // 清除单元格
            function clearCell(row, col) {
                const cell = document.getElementById(`cell-${row}-${col}`);
                if (cell.classList.contains('text-gray-800')) return;
                
                cell.textContent = '';
                cell.classList.remove('text-primary', 'cell-error');
                puzzle[row][col] = 0;
                updateNumberCounts();
                selectedNumber = null;
            }

            // 增加错误次数
            function incrementErrors() {
                errors++;
                updateErrorIndicators();
                
                if (errors >= maxErrors) {
                    showErrorsExceededModal();
                }
            }

            // 更新错误指示器
            function updateErrorIndicators() {
                const indicators = document.querySelectorAll('#error-indicators .error-indicator');
                indicators.forEach((ind, i) => {
                    if (i < errors) {
                        ind.classList.remove('error-indicator-filled');
                        ind.classList.add('error-indicator-empty');
                    } else {
                        ind.classList.remove('error-indicator-empty');
                        ind.classList.add('error-indicator-filled');
                    }
                });
            }

            // 显示错误超限弹窗
            function showErrorsExceededModal() {
                const modal = document.getElementById('errors-exceeded-modal');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('div').classList.add('scale-100');
                }, 10);
                clearInterval(timer);
            }

            // 隐藏错误弹窗
            function hideErrorsExceededModal() {
                const modal = document.getElementById('errors-exceeded-modal');
                modal.classList.remove('opacity-100');
                modal.querySelector('div').classList.remove('scale-100');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            // 生成新游戏
            function generateNewGame(difficulty = 'medium') {
                clearInterval(timer);
                timeElapsed = 0;
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('progress').textContent = '0%';
                gameStarted = true;
                errors = 0;
                hintCount = 3; // 重置提示计数
                document.getElementById('hint-count').textContent = `剩余提示: ${hintCount}`;
                document.getElementById('hint').disabled = false;
                updateErrorIndicators();
                selectedNumber = null;
                clearSameNumberHighlights();
                
                solution = generateSolution();
                board = JSON.parse(JSON.stringify(solution));
                puzzle = removeNumbers(board, difficulty);
                renderPuzzle();
                updateNumberCounts();
                startTimer();
                hideResultModal();
                hideErrorsExceededModal();
            }

            // 生成完整数独解（回溯法）
            function generateSolution() {
                const grid = Array(9).fill().map(() => Array(9).fill(0));
                
                function backtrack(row, col) {
                    if (row === 9) return true;
                    const nextRow = col === 8 ? row + 1 : row;
                    const nextCol = col === 8 ? 0 : col + 1;
                    const nums = shuffle([1,2,3,4,5,6,7,8,9]);
                    
                    for (const num of nums) {
                        if (isValid(grid, row, col, num)) {
                            grid[row][col] = num;
                            if (backtrack(nextRow, nextCol)) return true;
                            grid[row][col] = 0;
                        }
                    }
                    return false;
                }
                
                backtrack(0, 0);
                return grid;
            }

            // 检查数字有效性
            function isValid(grid, row, col, num) {
                for (let i = 0; i < 9; i++) {
                    if (grid[row][i] === num || grid[i][col] === num) return false;
                }
                
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let i = startRow; i < startRow + 3; i++) {
                    for (let j = startCol; j < startCol + 3; j++) {
                        if (grid[i][j] === num) return false;
                    }
                }
                return true;
            }

            // 随机打乱数组
            function shuffle(arr) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            // 根据难度移除数字
            function removeNumbers(board, difficulty) {
                const puzzle = JSON.parse(JSON.stringify(board));
                const removeCount = {
                    easy: 30, medium: 40, hard: 50, expert: 60
                }[difficulty] || 40;
                
                const cells = shuffle(Array(81).fill().map((_, i) => i));
                for (let i = 0; i < removeCount; i++) {
                    const cell = cells[i];
                    const row = Math.floor(cell / 9);
                    const col = cell % 9;
                    puzzle[row][col] = 0;
                }
                return puzzle;
            }

            // 渲染棋盘
            function renderPuzzle() {
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cell = document.getElementById(`cell-${i}-${j}`);
                        if (puzzle[i][j] !== 0) {
                            cell.textContent = puzzle[i][j];
                            cell.classList.add('text-gray-800');
                        } else {
                            cell.textContent = '';
                            cell.classList.remove('text-gray-800', 'text-primary', 'cell-error');
                        }
                    }
                }
            }

            // 开始计时
            function startTimer() {
                clearInterval(timer);
                timer = setInterval(() => {
                    timeElapsed++;
                    const mins = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
                    const secs = (timeElapsed % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${mins}:${secs}`;
                }, 1000);
            }

            // 检查游戏完成
            function checkGameCompletion() {
                let filled = 0, correct = 0;
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (puzzle[i][j] !== 0) {
                            filled++;
                            if (puzzle[i][j] === solution[i][j]) correct++;
                        }
                    }
                }
                
                const progress = Math.round((filled / 81) * 100);
                document.getElementById('progress').textContent = `${progress}%`;
                
                if (filled === 81 && correct === 81) {
                    clearInterval(timer);
                    showResultModal(true, 
                        `恭喜完成！用时 ${Math.floor(timeElapsed/60)}分${timeElapsed%60}秒，错误${errors}次`);
                }
            }

            // 显示结果弹窗
            function showResultModal(isSuccess, message) {
                const modal = document.getElementById('result-modal');
                const icon = document.getElementById('result-icon');
                const title = document.getElementById('result-title');
                
                if (isSuccess) {
                    icon.className = 'fa fa-trophy text-6xl text-accent mb-4';
                    title.textContent = '游戏完成！';
                    title.className = 'text-2xl font-bold mb-2 text-accent';
                } else {
                    icon.className = 'fa fa-info-circle text-6xl text-primary mb-4';
                    title.textContent = '提示';
                    title.className = 'text-2xl font-bold mb-2 text-primary';
                }
                
                document.getElementById('result-message').textContent = message;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('div').classList.add('scale-100');
                }, 10);
            }

            // 隐藏结果弹窗
            function hideResultModal() {
                const modal = document.getElementById('result-modal');
                modal.classList.remove('opacity-100');
                modal.querySelector('div').classList.remove('scale-100');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            // 获取提示
            function getHint() {
                if (!gameStarted || hintCount <= 0) return;
                
                // 找到第一个空单元格
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (puzzle[i][j] === 0) {
                            puzzle[i][j] = solution[i][j];
                            const cell = document.getElementById(`cell-${i}-${j}`);
                            cell.textContent = solution[i][j];
                            cell.classList.add('text-secondary');
                            updateNumberCounts();
                            checkGameCompletion();
                            hintCount--;
                            document.getElementById('hint-count').textContent = `剩余提示: ${hintCount}`;
                            if (hintCount === 0) {
                                document.getElementById('hint').disabled = true;
                            }
                            return;
                        }
                    }
                }
            }

            // 检查答案
            function checkAnswer() {
                let hasError = false;
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cell = document.getElementById(`cell-${i}-${j}`);
                        if (!cell.classList.contains('text-gray-800') && cell.textContent) {
                            const num = +cell.textContent;
                            if (num !== solution[i][j]) {
                                cell.classList.add('cell-error');
                                hasError = true;
                            } else {
                                cell.classList.remove('cell-error');
                            }
                        }
                    }
                }
                
                if (hasError) {
                    showResultModal(false, "检查发现错误，请查看标红单元格");
                } else {
                    checkGameCompletion();
                }
            }

            // 键盘事件
            document.addEventListener('keydown', (e) => {
                if (!selectedCell) return;
                
                const row = +selectedCell.dataset.row;
                const col = +selectedCell.dataset.col;
                
                // 数字键
                if (e.key >= '1' && e.key <= '9') {
                    const num = +e.key;
                    if (requiredNumbers.some(r => r.row === row && r.col === col && r.number !== num)) {
                        showResultModal(false, `此单元格必须填入数字 ${requiredNumbers.find(r => r.row === row && r.col === col)?.number}`);
                        return;
                    }
                    fillCell(row, col, num);
                }
                
                // 删除键
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    clearCell(row, col);
                }
                
                // 方向键导航
                if (e.key === 'ArrowUp' && row > 0) selectCell(row-1, col);
                if (e.key === 'ArrowDown' && row < 8) selectCell(row+1, col);
                if (e.key === 'ArrowLeft' && col > 0) selectCell(row, col-1);
                if (e.key === 'ArrowRight' && col < 8) selectCell(row, col+1);
            });

            // 事件监听
            document.getElementById('new-game').addEventListener('click', () => {
                generateNewGame(document.getElementById('difficulty').value);
            });
            
            document.getElementById('clear').addEventListener('click', () => {
                if (selectedCell) {
                    const row = +selectedCell.dataset.row;
                    const col = +selectedCell.dataset.col;
                    clearCell(row, col);
                }
            });
            
            document.getElementById('check').addEventListener('click', checkAnswer);
            document.getElementById('hint').addEventListener('click', getHint);
            // document.getElementById('solve').addEventListener('click', showSolution);
            document.getElementById('play-again').addEventListener('click', () => {
                generateNewGame(document.getElementById('difficulty').value);
            });
            
            // 难度选择变化时自动刷新游戏
            document.getElementById('difficulty').addEventListener('change', () => {
                generateNewGame(document.getElementById('difficulty').value);
            });

            document.getElementById('restart-after-errors').addEventListener('click', () => {
                generateNewGame(document.getElementById('difficulty').value);
            });

            // 初始化游戏
            initializeBoard();
            generateNewGame();
        });
    </script>
</body>
</html>